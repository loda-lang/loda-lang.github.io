---
layout: none
permalink: /programs/
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LODA Integer Sequence Browser</title>
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/css/loda.css">
  <link rel="stylesheet" href="/css/loda-browser.css">
  <link rel="stylesheet" href="/css/dark-mode.css">
  <!-- Highlight.js for code syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="highlight-theme">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="/js/loda-hljs-asm.js"></script>
  <script>hljs.highlightAll();</script>
  <!-- Dark Mode Toggle -->
  <script src="/js/dark-mode.js"></script>
  <!-- Begin Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="apple-mobile-web-app-title" content="LODA">
  <meta name="application-name" content="LODA">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <!-- End Favicon -->
  <!-- Remove or minimize custom inline styles to avoid overriding site look -->
  <style>
    .keyword-bar {
      margin-bottom: 1em;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3em;
    }
    .keyword-bar a {
      text-decoration: none;
    }
    .sequence-description { margin-bottom: 0.5em; }
    .pagination { margin: 1em 0; }
    .pagination a { margin: 0 0.5em; }
    .prefooter { margin-top: 2em; font-size: small; text-align: center; }
    .loda-program-container {
      margin-top: 0.5em;
      border: 1px solid var(--border-color, #ddd);
      border-radius: 4px;
      background: var(--code-bg, #f8f9fa);
    }
    .loda-program-code {
      padding: 1em;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      line-height: 1.4;
      overflow-x: auto;
      background: var(--code-bg, #f8f9fa);
      color: var(--text-color, #000);
    }
    .loda-program-buttons {
      padding: 0.5em;
      background: var(--header-bg, #e9ecef);
      border-top: 1px solid var(--border-color, #ddd);
      display: flex;
      gap: 0.5em;
      align-items: center;
    }
    .loda-pari-container {
      padding: 1em;
      background: var(--code-bg, #f8f9fa);
      border-top: 1px solid var(--border-color, #ddd);
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      line-height: 1.4;
      white-space: pre-wrap;
      color: var(--text-color, #000);
    }
    .loda-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.3em 0.8em;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.85em;
      text-decoration: none;
      display: inline-block;
      box-sizing: border-box;
      line-height: 1.5;
      vertical-align: middle;
    }
    .loda-button:hover {
      background: #0056b3;
      color: white;
      text-decoration: none;
    }
    .loda-button.secondary {
      background: #b817b0;
      color: white;
    }
    .loda-button.secondary:hover {
      background: #8a1284;
      color: white;
      text-decoration: none;
    }
    .loda-button.copy {
      background: #28a745;
    }
    .loda-button.copy:hover {
      background: #218838;
    }
    .loda-button.copy.copied {
      background: #6c757d;
    }
    .loading-text {
      color: #666;
      font-style: italic;
    }
    #search-form {
      display: flex;
      align-items: center;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    #search-input {
      flex: 1;
      padding: 0.3em 0.8em;
      border: 1px solid var(--border-color, #ddd);
      border-radius: 3px;
      font-size: inherit;
      height: 2.2em;
      min-width: 80px;
      box-sizing: border-box;
    }
    #search-submit {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.3em 0.8em;
      border-radius: 3px;
      cursor: pointer;
      font-size: inherit;
      height: 2.2em;
      min-width: 80px;
    }
    #search-submit:hover {
      background: #0056b3;
    }
    #shuffle-button {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.3em 0.8em;
      border-radius: 3px;
      cursor: pointer;
      font-size: inherit;
      height: 2.2em;
      min-width: 80px;
    }
    #shuffle-button:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="wrapper">
      <a class="site-title" rel="author" href="/">
        <picture>
          <source srcset="/images/loda-top-icon.png 1x, /images/loda-top-icon@2x.png 2x, /images/loda-top-icon@3x.png 3x">
          <img src="/images/loda-top-icon.png" alt="Logo of the LODA language">
        </picture>
        <span>LODA Language</span>
      </a>
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>
        <div class="trigger">
          {% include navigation.html active_url="/programs/" %}
        </div>
      </nav>
    </div>
  </header>
  <main class="page-content" aria-label="Content">
    <div class="wrapper">
      <article class="post">
        <header class="post-header">
          <h1 class="post-title">Integer Sequences and LODA Programs</h1>
        </header>
        <div class="post-content">
          <form id="search-form">
            <input type="text" id="search-input" name="search" autocomplete="off">
            <input type="submit" id="search-submit" value="Search">
            <button type="button" id="shuffle-button">Shuffle</button>
          </form>
          <div class="keyword-bar" id="keyword-bar"></div>
          <div id="results-info"></div>
          <div id="sequence-list" class="sequence-list"></div>
          <div class="pagination" id="pagination"></div>
        </div>
      </article>
    </div>
  </main>
  <div class="prefooter">
    LODA is published under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.<br>
    Sequence names are published under the <a target="_blank" href="http://oeis.org/wiki/The_OEIS_End-User_License_Agreement">OEIS End-User License Agreement</a>.<br>
    <a target="_blank" href="https://github.com/loda-lang/loda-api/issues">Report an issue</a>.
  </div>
  <script>

    // --- Constants ---
    const API_BASE_URL = 'https://api.loda-lang.org/v2';
    const EDITOR_BASE_URL = 'https://loda-lang.org/edit/';
    const OEIS_BASE_URL = 'https://oeis.org/';
    
    const BUTTON_STATES = {
      COLLAPSED: 'LODA ▼',
      EXPANDED: 'LODA ▲',
      LOADING: 'Loading...',
      ERROR: 'Error loading',
      PARI_COLLAPSED: 'PARI ▼',
      PARI_EXPANDED: 'PARI ▲',
      PARI_LOADING: 'Loading PARI...',
      PARI_ERROR: 'PARI Error',
      LEAN_COLLAPSED: 'LEAN ▼',
      LEAN_EXPANDED: 'LEAN ▲',
      LEAN_LOADING: 'Loading LEAN...',
      LEAN_ERROR: 'LEAN Error'
    };
    
    const CSS_CLASSES = {
      LODA_BUTTON: 'loda-button',
      LODA_BUTTON_SECONDARY: 'loda-button secondary',
      PROGRAM_CONTAINER: 'loda-program-container',
      PROGRAM_CODE: 'loda-program-code',
      PROGRAM_BUTTONS: 'loda-program-buttons',
      PARI_CONTAINER: 'loda-pari-container',
      LEAN_CONTAINER: 'loda-pari-container',
      LANGUAGE_ASM: 'language-asm'
    };
    
    const DEFAULT_CONFIG = {
      SEARCH_LIMIT: 100,
      DEFAULT_KEYWORDS: ['loda', '-dumb'],
      ERROR_DISPLAY_DURATION: 2000
    };

    // --- Keyword definitions (dynamic from API) ---
    let KEYWORD_DESCRIPTIONS = {};
    let ALL_KEYWORDS = [];

    async function fetchKeywords() {
      const resp = await fetch(`${API_BASE_URL}/stats/keywords`);
      if (!resp.ok) return;
      const data = await resp.json();
      // data is an array of { name, description }
      KEYWORD_DESCRIPTIONS = {};
      ALL_KEYWORDS = [];
      data.forEach(k => {
        KEYWORD_DESCRIPTIONS[k.name] = k.description;
        ALL_KEYWORDS.push(k.name);
      });
      // ALL_KEYWORDS.sort();
    }

    // --- State ---
    let state_params = new URLSearchParams(window.location.search);
    let hasQuery = (state_params.get('q') !== null) || (state_params.get('kw') !== null);
    let state = {
      search: state_params.get('q') !== null ? state_params.get('q') : '',
      keywords: hasQuery ? (state_params.get('kw') !== null ? state_params.get('kw').split(' ') : []) : DEFAULT_CONFIG.DEFAULT_KEYWORDS,
      start: 0,
      limit: DEFAULT_CONFIG.SEARCH_LIMIT,
      count: 0
    };
    
    // --- Helpers for keyword selection ---
    function toggleKeyword(k) {
      let idx = state.keywords.indexOf(k);
      let minusIdx = state.keywords.indexOf('-'+k);
      if (idx !== -1) {
        state.keywords[idx] = '-' + k;
      } else if (minusIdx !== -1) {
        state.keywords.splice(minusIdx, 1);
      } else {
        // Prevent duplicate 'loda' if already present
        if (!state.keywords.includes(k)) {
          state.keywords.push(k);
        }
      }
      state.start = 0;
      update();
    }
    function keywordClass(k) {
      if (state.keywords.includes(k)) return 'keyword-plus';
      if (state.keywords.includes('-'+k)) return 'keyword-minus';
      return 'keyword-name';
    }
    function keywordLabel(k) {
      if (state.keywords.includes(k)) return '+'+k;
      if (state.keywords.includes('-'+k)) return '-'+k;
      return k;
    }

    // --- Render keyword bar ---
    function renderKeywordBar() {
      const bar = document.getElementById('keyword-bar');
      bar.innerHTML = '';
      ALL_KEYWORDS.forEach(k => {
        const a = document.createElement('a');
        a.href = '#';
        a.title = KEYWORD_DESCRIPTIONS[k] || k;
        a.onclick = (e) => { e.preventDefault(); toggleKeyword(k); };
        const span = document.createElement('span');
        span.className = keywordClass(k);
        span.textContent = keywordLabel(k);
        a.appendChild(span);
        bar.appendChild(a);
      });
    }

    // --- Fetch and render sequence list ---
    async function fetchSequences(shuffle = false) {
      let q = state.search.trim();
      let keywords = state.keywords.filter(k => !k.startsWith('-')).join(' ');
      let exclude = state.keywords.filter(k => k.startsWith('-')).map(k => '-'+k.slice(1)).join(' ');
      let query = [keywords, exclude, q].filter(Boolean).join(' ');
      let url = `${API_BASE_URL}/sequences/search?q=${encodeURIComponent(query)}&limit=${state.limit}&skip=${state.start}`;
      if (shuffle) {
        url += '&shuffle=true';
      }
      let resp = await fetch(url);
      if (!resp.ok) return { total: 0, results: [] };
      let data = await resp.json();
      // The API now returns { total, results }
      return { total: data.total || 0, results: data.results || [] };
    }

    // --- Fetch LODA program code ---
    async function fetchLodaProgram(sequenceId) {
      try {
        const url = `${API_BASE_URL}/programs/${sequenceId}`;
        const resp = await fetch(url);
        if (!resp.ok) return null;
        const data = await resp.json();
        return data.code;
      } catch (error) {
        console.error('Error fetching LODA program:', error);
        return null;
      }
    }

    // --- Fetch export in specified format ---
    async function fetchExport(sequenceId, programCode, format) {
      try {
        const url = `${API_BASE_URL}/programs/export?format=${format}`;
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: programCode
        });
        if (!resp.ok) return null;
        const data = await resp.json();
        return data.status === 'success' ? data.output : null;
      } catch (error) {
        console.error(`Error fetching ${format.toUpperCase()} export:`, error);
        return null;
      }
    }

    // --- Copy to clipboard helper function ---
    async function copyToClipboard(text, button) {
      try {
        await navigator.clipboard.writeText(text);
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      } catch (error) {
        console.error('Error copying to clipboard:', error);
        const originalText = button.textContent;
        button.textContent = 'Copy failed';
        setTimeout(() => {
          button.textContent = originalText;
        }, 2000);
      }
    }

    // --- Toggle PARI export display ---
    async function togglePariExport(sequenceId, button, otherButton, programContainer, programCode) {
      const pariId = `loda-pari-${sequenceId}`;
      const pariButtonsId = `loda-pari-buttons-${sequenceId}`;
      const leanId = `loda-lean-${sequenceId}`;
      const leanButtonsId = `loda-lean-buttons-${sequenceId}`;
      let pariContainer = document.getElementById(pariId);
      let pariButtonsContainer = document.getElementById(pariButtonsId);
      let leanContainer = document.getElementById(leanId);
      let leanButtonsContainer = document.getElementById(leanButtonsId);
      
      if (pariContainer) {
        // If PARI is already shown, hide it
        pariContainer.remove();
        if (pariButtonsContainer) {
          pariButtonsContainer.remove();
        }
        button.textContent = BUTTON_STATES.PARI_COLLAPSED;
        return;
      }
      
      // Close LEAN export if it's open
      if (leanContainer) {
        leanContainer.remove();
        if (leanButtonsContainer) {
          leanButtonsContainer.remove();
        }
        otherButton.textContent = BUTTON_STATES.LEAN_COLLAPSED;
      }
      
      // Show loading state
      button.textContent = BUTTON_STATES.PARI_LOADING;
      button.disabled = true;
      
      // Fetch the PARI export
      const pariCode = await fetchExport(sequenceId, programCode, 'pari');
      
      if (pariCode) {
        // Create PARI container
        pariContainer = document.createElement('div');
        pariContainer.id = pariId;
        pariContainer.className = CSS_CLASSES.PARI_CONTAINER;
        pariContainer.textContent = pariCode;
        
        // Create buttons container for PARI
        const pariButtonsContainer = document.createElement('div');
        pariButtonsContainer.id = pariButtonsId;
        pariButtonsContainer.className = CSS_CLASSES.PROGRAM_BUTTONS;
        
        // Add "Try it out" button for PARI
        const pariTryButton = document.createElement('a');
        pariTryButton.className = CSS_CLASSES.LODA_BUTTON_SECONDARY;
        pariTryButton.href = 'https://pari.math.u-bordeaux.fr/gp.html';
        pariTryButton.target = '_blank';
        pariTryButton.textContent = 'Try it out';
        pariTryButton.onclick = async (e) => {
          // Copy code to clipboard before opening PARI page
          try {
            await navigator.clipboard.writeText(pariCode);
          } catch (error) {
            console.error('Failed to copy PARI code:', error);
          }
        };
        pariButtonsContainer.appendChild(pariTryButton);
        
        const pariCopyButton = document.createElement('button');
        pariCopyButton.className = CSS_CLASSES.LODA_BUTTON + ' copy';
        pariCopyButton.textContent = 'Copy';
        pariCopyButton.onclick = () => copyToClipboard(pariCode, pariCopyButton);
        pariButtonsContainer.appendChild(pariCopyButton);
        
        programContainer.appendChild(pariContainer);
        programContainer.appendChild(pariButtonsContainer);
        
        button.textContent = BUTTON_STATES.PARI_EXPANDED;
      } else {
        button.textContent = BUTTON_STATES.PARI_ERROR;
        setTimeout(() => {
          button.textContent = BUTTON_STATES.PARI_COLLAPSED;
        }, DEFAULT_CONFIG.ERROR_DISPLAY_DURATION);
      }
      
      button.disabled = false;
    }

    // --- Toggle LEAN export display ---
    async function toggleLeanExport(sequenceId, button, otherButton, programContainer, programCode) {
      const leanId = `loda-lean-${sequenceId}`;
      const leanButtonsId = `loda-lean-buttons-${sequenceId}`;
      const pariId = `loda-pari-${sequenceId}`;
      const pariButtonsId = `loda-pari-buttons-${sequenceId}`;
      let leanContainer = document.getElementById(leanId);
      let leanButtonsContainer = document.getElementById(leanButtonsId);
      let pariContainer = document.getElementById(pariId);
      let pariButtonsContainer = document.getElementById(pariButtonsId);
      
      if (leanContainer) {
        // If LEAN is already shown, hide it
        leanContainer.remove();
        if (leanButtonsContainer) {
          leanButtonsContainer.remove();
        }
        button.textContent = BUTTON_STATES.LEAN_COLLAPSED;
        return;
      }
      
      // Close PARI export if it's open
      if (pariContainer) {
        pariContainer.remove();
        if (pariButtonsContainer) {
          pariButtonsContainer.remove();
        }
        otherButton.textContent = BUTTON_STATES.PARI_COLLAPSED;
      }
      
      // Show loading state
      button.textContent = BUTTON_STATES.LEAN_LOADING;
      button.disabled = true;
      
      // Fetch the LEAN export
      const leanCode = await fetchExport(sequenceId, programCode, 'lean');
      
      if (leanCode) {
        // Create LEAN container
        leanContainer = document.createElement('div');
        leanContainer.id = leanId;
        leanContainer.className = CSS_CLASSES.LEAN_CONTAINER;
        leanContainer.textContent = leanCode;
        
        // Create buttons container for LEAN
        const leanButtonsContainer = document.createElement('div');
        leanButtonsContainer.id = leanButtonsId;
        leanButtonsContainer.className = CSS_CLASSES.PROGRAM_BUTTONS;
        
        const leanCopyButton = document.createElement('button');
        leanCopyButton.className = CSS_CLASSES.LODA_BUTTON + ' copy';
        leanCopyButton.textContent = 'Copy';
        leanCopyButton.onclick = () => copyToClipboard(leanCode, leanCopyButton);
        leanButtonsContainer.appendChild(leanCopyButton);
        
        programContainer.appendChild(leanContainer);
        programContainer.appendChild(leanButtonsContainer);
        
        button.textContent = BUTTON_STATES.LEAN_EXPANDED;
      } else {
        button.textContent = BUTTON_STATES.LEAN_ERROR;
        setTimeout(() => {
          button.textContent = BUTTON_STATES.LEAN_COLLAPSED;
        }, DEFAULT_CONFIG.ERROR_DISPLAY_DURATION);
      }
      
      button.disabled = false;
    }

    // --- Render sequence list ---
    function renderSequenceList(results) {
      const list = document.getElementById('sequence-list');
      list.innerHTML = '';
      results.forEach((entry, index) => {
        const row0 = document.createElement('div');
        row0.className = 'col0';
        const oeisLink = document.createElement('a');
        oeisLink.target = '_blank';
        oeisLink.href = `${OEIS_BASE_URL}${entry.id}`;
        oeisLink.textContent = entry.id;
        row0.appendChild(oeisLink);
        
        const row1 = document.createElement('div');
        row1.className = 'col1';
        const linkbox = document.createElement('div');
        linkbox.className = 'linkbox';
        
        // Show LODA program button only if 'loda' keyword is present
        if (entry.keywords && Array.isArray(entry.keywords) && entry.keywords.includes('loda')) {
          const lodaButton = document.createElement('button');
          lodaButton.className = CSS_CLASSES.LODA_BUTTON;
          lodaButton.textContent = BUTTON_STATES.COLLAPSED;
          lodaButton.onclick = () => toggleLodaProgram(entry.id, lodaButton, row1, entry.keywords);
          linkbox.appendChild(lodaButton);
        }
        
        row1.appendChild(linkbox);
        const desc = document.createElement('div');
        desc.className = 'sequence-description';
        desc.textContent = entry.name;
        row1.appendChild(desc);
        
        list.appendChild(row0);
        list.appendChild(row1);
      });
    }

    // --- Toggle LODA program display ---
    async function toggleLodaProgram(sequenceId, button, container, keywords) {
      const programId = `loda-program-${sequenceId}`;
      let programContainer = document.getElementById(programId);
      
      if (programContainer) {
        // If program is already shown, hide it
        programContainer.remove();
        button.textContent = BUTTON_STATES.COLLAPSED;
        return;
      }
      
      // Show loading state
      button.textContent = BUTTON_STATES.LOADING;
      button.disabled = true;
      
      // Fetch the program code
      const code = await fetchLodaProgram(sequenceId);
      
      if (code) {
        // Create program container
        programContainer = document.createElement('div');
        programContainer.id = programId;
        programContainer.className = CSS_CLASSES.PROGRAM_CONTAINER;
        
        // Create code container
        const codeContainer = document.createElement('pre');
        codeContainer.className = CSS_CLASSES.PROGRAM_CODE;
        const codeElement = document.createElement('code');
        codeElement.className = CSS_CLASSES.LANGUAGE_ASM;
        codeElement.textContent = code;
        codeContainer.appendChild(codeElement);
        
        // Create buttons container (moved below code)
        const buttonsContainer = document.createElement('div');
        buttonsContainer.className = CSS_CLASSES.PROGRAM_BUTTONS;
        
        const editButton = document.createElement('a');
        editButton.className = CSS_CLASSES.LODA_BUTTON_SECONDARY;
        editButton.href = `${EDITOR_BASE_URL}?oeis=${sequenceId.slice(1)}`;
        editButton.target = '_blank';
        editButton.textContent = 'Try it out';
        
        buttonsContainer.appendChild(editButton);
        
        // Add copy button for LODA program
        const copyButton = document.createElement('button');
        copyButton.className = CSS_CLASSES.LODA_BUTTON + ' copy';
        copyButton.textContent = 'Copy';
        copyButton.onclick = () => copyToClipboard(code, copyButton);
        buttonsContainer.appendChild(copyButton);
        
        // Show PARI button only if 'loda-pari' keyword is present
        let pariButton = null;
        let leanButton = null;
        if (keywords && Array.isArray(keywords) && keywords.includes('loda-pari')) {
          pariButton = document.createElement('button');
          pariButton.className = CSS_CLASSES.LODA_BUTTON;
          pariButton.textContent = BUTTON_STATES.PARI_COLLAPSED;
          buttonsContainer.appendChild(pariButton);
        }

        // Show LEAN button only if 'loda-lean' keyword is present
        if (keywords && Array.isArray(keywords) && keywords.includes('loda-lean')) {
          leanButton = document.createElement('button');
          leanButton.className = CSS_CLASSES.LODA_BUTTON;
          leanButton.textContent = BUTTON_STATES.LEAN_COLLAPSED;
          buttonsContainer.appendChild(leanButton);
        }

        // Set up onclick handlers with cross-references, guarding missing buttons
        if (pariButton) {
          pariButton.onclick = () => togglePariExport(sequenceId, pariButton, leanButton, programContainer, code);
        }
        if (leanButton) {
          leanButton.onclick = () => toggleLeanExport(sequenceId, leanButton, pariButton, programContainer, code);
        }
        
        programContainer.appendChild(codeContainer);
        programContainer.appendChild(buttonsContainer);
        container.appendChild(programContainer);
        
        // Apply syntax highlighting
        hljs.highlightElement(codeElement);
        
        button.textContent = BUTTON_STATES.EXPANDED;
      } else {
        button.textContent = BUTTON_STATES.ERROR;
        setTimeout(() => {
          button.textContent = BUTTON_STATES.COLLAPSED;
        }, DEFAULT_CONFIG.ERROR_DISPLAY_DURATION);
      }
      
      button.disabled = false;
    }

    // --- Render pagination ---
    function renderPagination() {
      const pag = document.getElementById('pagination');
      pag.innerHTML = '';
      if (state.start > 0) {
        const prev = document.createElement('a');
        prev.href = '#';
        prev.textContent = '« Previous';
        prev.onclick = (e) => { e.preventDefault(); state.start = Math.max(0, state.start - state.limit); update(); };
        pag.appendChild(prev);
      }
      if (state.count > state.start + state.limit) {
        if (state.start > 0) pag.appendChild(document.createTextNode(' | '));
        const next = document.createElement('a');
        next.href = '#';
        next.textContent = 'Next »';
        next.onclick = (e) => { e.preventDefault(); state.start += state.limit; update(); };
        pag.appendChild(next);
      }
    }

    // --- Main update function ---
    async function update(shuffle = false) {
      if (ALL_KEYWORDS.length === 0) {
        await fetchKeywords();
      }
      renderKeywordBar();
      document.getElementById('search-input').value = state.search;
      document.getElementById('results-info').textContent = 'Loading...';
      let { total, results } = await fetchSequences(shuffle);
      
      // update query string
      let state_params = new URLSearchParams();
      if (state.search && state.search.trim() !== '') {
        state_params.set('q', state.search);
      }
      const kwString = state.keywords.join(' ').trim();
      if (kwString !== '') {
        state_params.set('kw', kwString);
      }
      const paramString = state_params.toString();
      const url = paramString ? ('/programs?' + paramString) : '/programs';
      window.history.pushState(null, '', url);
      
      state.count = total;
      if (results.length === 0) {
        document.getElementById('results-info').textContent = 'No results.';
      } else {
        let end = state.start + results.length;
        document.getElementById('results-info').textContent = `Showing ${state.start+1}-${end} of ${total} results:`;
      }
      renderSequenceList(results);
      renderPagination();
    }

    // --- Search form handler ---
    document.getElementById('search-form').onsubmit = function(e) {
      e.preventDefault();
      state.search = document.getElementById('search-input').value.trim();
      state.start = 0;
      update();
    };

    // --- Shuffle button handler ---
    document.getElementById('shuffle-button').onclick = function(e) {
      e.preventDefault();
      state.search = document.getElementById('search-input').value.trim();
      state.start = 0;
      update(true); // Pass shuffle=true
    };

    // --- Initial load ---
    update();
  </script>
</body>
</html>
